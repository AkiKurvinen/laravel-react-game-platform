<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <script src="/game/gameLib/gameLib.js"></script>
    <script src="/game/assets/loginform.js"></script>
    <link rel="shortcut icon" href="../img/box_logo.png" type="image/x-icon">
    <link rel="stylesheet" href="/game/assets/loginform.css">
</head>

<body>
    <script>
    var locationtxt;
    var box_location = [0, 0]
    var user_id = 0;
    var user_name = "";

        class Example extends Phaser.Scene {
            constructor() {
                super();
            }

            preload() {
                this.load.image('rocket', 'img/steelbox.png');
                this.load.html('loginform', '/game/assets/loginform.html');
            }


            async create() {
                this.add.text(16, 16, 'Drag the Box').setFontSize(24).setShadow(1, 1);
                locationtxt = this.add.text(16, 64, `X: 0 - Y: 0`).setFontSize(24).setShadow(1, 1);

                const container = this.add.container(400, 300);
                container.setSize(120, 80);
                container.setInteractive({ draggable: true });
                const rocket = this.add.sprite(0, 0, 'rocket', 'rocket');
                container.add([rocket]);
                locationtxt.setText(`X: ${container.x} - Y: ${container.y}`)
                container.on('drag', (pointer, dragX, dragY) => {
                    container.setPosition(dragX, dragY)
                    box_location = [dragX, dragY]
                    locationtxt.setText(`X: ${dragX} - Y: ${dragY}`)
                });

                // Save position button
                const button_save = this.add.text(700, 550, 'Save position', {
                    fontFamily: 'Arial',
                    fontSize: '16px',
                    color: '#ffffff',
                    align: 'center',
                    fixedWidth: 120,
                    backgroundColor: '#2d2d2d'
                }).setPadding(8).setOrigin(0.5);
                button_save.setInteractive({ useHandCursor: true });
                button_save.on('pointerover', () => {
                    button_save.setBackgroundColor('#8d8d8d');
                });
                button_save.on('pointerout', () => {
                    button_save.setBackgroundColor('#2d2d2d');
                });
                button_save.on('pointerdown', () => {
                    button_save.setBackgroundColor('#000');
                    saveBoxLocation()
                });

                // game specific API Methods
                const saveBoxLocation = async () => {
                    const instance = new gameApi("box-mover");
                    await instance.updateLeaderboard(box_location[0] + box_location[1]);
                    await instance.saveGamestate({ "x": box_location[0], "y": box_location[1] });
                }
                const getUserBoxlocation = async () => {
                    const instance = new gameApi("box-mover");
                    let gamestate = (await instance.getGamestate());
                    gamestate ??= { "x": 400, "y": 300 };
                    return [gamestate.x, gamestate.y]
                }

                // login form - loaded from HTML file
                const text = this.add.text(780, 10, 'Not logged in', { color: 'white', fontSize: '16px ' }).setOrigin(1, 0);
                const html_login_form = this.add.dom(350, 300).createFromCache('loginform');

                // game specific stuff after login
                const game_specific_stuff = async (user, isNewUser, skip) => {
                    const user_box_location = await getUserBoxlocation();
                    box_location = user_box_location;
                    container.setPosition(box_location[0], box_location[1]);
                    locationtxt.setText(`X: ${box_location[0]} - Y: ${box_location[1]}`);
                    if (skip) {
                        button_save.setVisible(false);
                        text.setText(`Welcome ${user.username} (${user.id})`);
                        return true;
                    }
                    text.setText(`Welcome ${isNewUser ? 'new' : 'back'} ${user.username} (${user.id})`);
                    return true;
                }

                const click_handler = async (event) => {
                    if (event.target.name === 'login') {
                        const res = await form_login_handler(html_login_form)
                        if (res && res.username) {
                            await game_specific_stuff(res, false, false)
                        }
                    }
                    else if (event.target.name === 'join') {
                        const res = await form_join_handler(html_login_form)
                        if (res && res.username) {
                            await game_specific_stuff(res, true, false)
                        }
                    }
                    else if (event.target.name === 'skip') {
                        const res = await form_skip_handler(html_login_form)
                        await game_specific_stuff(res, false, true)
                    }
                }

                // first try to auto login user by session
                const userinfo = await autoLogin()
                const autologinsuccess = userinfo && userinfo.id !== undefined && userinfo.id !== null

                if (!autologinsuccess) {
                    html_login_form.addListener('click');
                    html_login_form.on('click', click_handler);
                    return
                }

                user_name = userinfo.username
                user_id = userinfo.id
                html_login_form.setVisible(false);
                text.setText(`Autologged as ${user_name} (${user_id})`);

                // game specific stuff
                const user_box_location = await getUserBoxlocation()
                box_location = user_box_location === undefined ? [400, 300] : user_box_location;
                container.setPosition(box_location[0], box_location[1]);
                locationtxt.setText(`X: ${box_location[0]} - Y: ${box_location[1]}`);
            }

        }

        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'phaser-example',
            scene: Example,
            dom: {
                createContainer: true
            },
        };

        const game = new Phaser.Game(config);
    </script>

</body>

</html>